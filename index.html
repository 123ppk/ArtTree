<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clinic Appointment System</title>
<style>
body{font-family:'Segoe UI',sans-serif;margin:0;padding:0;background:#fff;color:#000;min-height:100vh;display:flex;flex-direction:column;}
header{padding:10px 20px;text-align:center;font-size:20px;font-weight:600;position:relative;background:#f1f5ff;}
header button.logout{position:absolute;right:8px;top:8px;border:1px solid #dc2626;color:#dc2626;background:#fff;padding:2px 6px;border-radius:4px;font-size:11px;cursor:pointer;display:none; width:auto;}
.container{flex:1;padding:15px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
form{padding:15px;background:#fff;border-radius:10px;border:1px solid #ddd;margin-bottom:10px;width:100%;max-width:350px;box-sizing:border-box;}
input,select,button{padding:6px;margin:5px 0;width:100%;border-radius:6px;border:1px solid #ddd;box-sizing:border-box;font-size:13px;}
input:focus,select:focus{border-color:#2563eb;outline:none;}
button{cursor:pointer;}
button.outline{border:1px solid #2563eb;background:#fff;color:#2563eb;font-weight:500;}
button.outline:hover{background:#2563eb;color:#fff;}
.admin-dashboard{display:flex;width:100%;gap:15px;align-items:flex-start;flex-wrap:wrap;}
.forms{flex:1;min-width:280px;max-width:320px;display:flex;flex-direction:column;max-height:600px;overflow-y:auto;}
.cards-container{flex:2;display:flex;flex-direction:column;align-items:center;max-height:600px;overflow-y:auto;width:100%;}
.cards{display:flex;flex-wrap:wrap;gap:12px;justify-content:flex-start;}
.card{background:#fff;padding:10px;border-radius:10px;border:1px solid #ddd;min-width:220px;max-width:260px;text-align:left;font-size:13px;flex:1;}
.card h3{margin:5px 0;font-size:15px;color:#000;}
.card p{margin:3px 0;font-size:13px;color:#000;}
.card button{padding:4px 8px;font-size:12px;margin:3px;}
#searchBox{width:90%;max-width:400px;padding:6px;border-radius:6px;border:1px solid #ccc;margin:5px auto 10px auto;font-size:13px;display:block;}
#authPage,#adminPage,#doctorPage,#patientPage{width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;}
@media(max-width:800px){.admin-dashboard{flex-direction:column;align-items:center;}.cards-container{align-items:center;}.cards{justify-content:center;}}
</style>
</head>
<body>
<header>
Clinic Appointment System
<button class="logout" onclick="logout()" id="logoutBtn">Logout</button>
</header>

<div class="container">
<!-- Login / Signup -->
<div id="authPage">
<form id="loginForm">
<h2>Login</h2>
<input type="email" id="loginEmail" placeholder="Email" required>
<input type="password" id="loginPassword" placeholder="Password" required>
<select id="loginRole">
<option value="admin">Admin</option>
<option value="doctor">Doctor</option>
<option value="patient">Patient</option>
</select>
<button type="submit" class="outline">Login</button>
<button type="button" class="outline" id="showSignup">Sign Up</button>
</form>

<form id="signupForm" style="display:none;">
<h2>Sign Up</h2>
<input type="text" id="signupName" placeholder="Name" required>
<input type="email" id="signupEmail" placeholder="Email" required>
<input type="password" id="signupPassword" placeholder="Password" required>
<select id="signupRole">
<option value="doctor">Doctor</option>
<option value="patient">Patient</option>
</select>
<button type="submit" class="outline">Sign Up</button>
<button type="button" class="outline" id="showLogin">Back to Login</button>
</form>
</div>

<!-- Admin Dashboard -->
<div id="adminPage" style="display:none;width:100%;">
<div class="admin-dashboard">
<div class="forms">
<form id="clinicForm">
<h3>Add Clinic</h3>
<input type="text" id="clinicName" placeholder="Clinic Name" required>
<input type="text" id="clinicAddress" placeholder="Clinic Address" required>
<input type="text" id="clinicPhone" placeholder="Phone No" required>
<button type="submit" class="outline">Add Clinic</button>
</form>
<form id="doctorForm">
<h3>Add Doctor</h3>
<input type="text" id="doctorName" placeholder="Doctor Name" required>
<input type="email" id="doctorEmail" placeholder="Doctor Email" required>
<input type="password" id="doctorPassword" placeholder="Doctor Password" required>
<select id="doctorClinic"></select>
<button type="submit" class="outline">Add Doctor</button>
</form>
<form id="patientForm">
<h3>Add Patient</h3>
<input type="text" id="patientName" placeholder="Patient Name" required>
<input type="email" id="patientEmail" placeholder="Patient Email" required>
<input type="password" id="patientPassword" placeholder="Patient Password" required>
<input type="text" id="patientPhone" placeholder="Phone No" required>
<input type="number" id="patientAge" placeholder="Age" required>
<input type="text" id="patientProblem" placeholder="Problem" required>
<input type="date" id="patientDate" required>
<input type="time" id="patientTime" required>
<select id="patientDay" required>
  <option value="">Select Day</option>
  <option>Monday</option>
  <option>Tuesday</option>
  <option>Wednesday</option>
  <option>Thursday</option>
  <option>Friday</option>
  <option>Saturday</option>
  <option>Sunday</option>
</select>
<input type="text" id="patientAddress" placeholder="Address" required>
<select id="patientDoctor"></select>
<button type="submit" class="outline">Add Patient</button>
</form>
</div>
<div class="cards-container">
<input type="text" id="searchBox" placeholder="Search patients...">
<div class="cards" id="patientsContainer"></div>
</div>
</div>
</div>

<!-- Doctor Dashboard -->
<div id="doctorPage" style="display:none;">
<h2>Doctor Dashboard</h2>
<div class="cards" id="doctorPatients"></div>
</div>

<!-- Patient Dashboard -->
<div id="patientPage" style="display:none;">
<h2>Patient Dashboard</h2>
<div class="cards" id="myCard"></div>
</div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js"></script>

<script>
/* ----------------- CONFIG -----------------
 Replace this config with your project's config from Firebase console (if different).
 If you already have a Firebase project, use its config. The project below is the example used earlier.
-------------------------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyAIje3aPJK5BeZ9u0M-PY3rrZHPBZCsp7I",
  authDomain: "patient-app-9d81f.firebaseapp.com",
  databaseURL: "https://patient-app-9d81f-default-rtdb.firebaseio.com",
  projectId: "patient-app-9d81f",
  storageBucket: "patient-app-9d81f.appspot.com",
  messagingSenderId: "86486627512",
  appId: "1:86486627512:web:595270284159741947f04d"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let users = [];
let clinics = [];
let doctors = [];
let patients = [];

/* DOM */
const loginForm = document.getElementById("loginForm");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const loginRole = document.getElementById("loginRole");
const logoutBtn = document.getElementById("logoutBtn");
const authPage = document.getElementById("authPage");
const adminPage = document.getElementById("adminPage");
const doctorPage = document.getElementById("doctorPage");
const patientPage = document.getElementById("patientPage");

const clinicForm = document.getElementById("clinicForm");
const doctorForm = document.getElementById("doctorForm");
const patientForm = document.getElementById("patientForm");
const doctorClinic = document.getElementById("doctorClinic");
const patientDoctor = document.getElementById("patientDoctor");
const patientsContainer = document.getElementById("patientsContainer");
const doctorPatients = document.getElementById("doctorPatients");
const myCard = document.getElementById("myCard");
const searchBox = document.getElementById("searchBox");

const signupForm = document.getElementById("signupForm");
const signupName = document.getElementById("signupName");
const signupEmail = document.getElementById("signupEmail");
const signupPassword = document.getElementById("signupPassword");
const signupRole = document.getElementById("signupRole");
const showSignup = document.getElementById("showSignup");
const showLogin = document.getElementById("showLogin");

/* default admin creds (kept as you requested) */
const DEFAULT_ADMIN_EMAIL = "admin@wec.com";
const DEFAULT_ADMIN_PASSWORD = "admin123";
const DEFAULT_ADMIN_NAME = "Admin";

/* ensure default admin exists (create in Auth & DB if absent) */
function ensureDefaultAdmin(){
  db.ref('users').once('value').then(snap=>{
    const data = snap.val() || {};
    const adminExists = Object.values(data).some(u=>u && u.role==='admin');
    if(adminExists) return; // already exists in DB
    // try to create auth user
    auth.createUserWithEmailAndPassword(DEFAULT_ADMIN_EMAIL, DEFAULT_ADMIN_PASSWORD)
      .then(userCred=>{
        const uid = userCred.user.uid;
        const adminObj = { name: DEFAULT_ADMIN_NAME, email: DEFAULT_ADMIN_EMAIL, role: 'admin' };
        return db.ref('users/' + uid).set(adminObj);
      })
      .then(()=>{
        console.log('Default admin created in Auth + DB.');
        auth.signOut();
      })
      .catch(err=>{
        // if email already in use, try signing in to get uid then ensure DB entry
        if(err.code === 'auth/email-already-in-use'){
          auth.signInWithEmailAndPassword(DEFAULT_ADMIN_EMAIL, DEFAULT_ADMIN_PASSWORD)
            .then(userCred=>{
              const uid = userCred.user.uid;
              return db.ref('users/' + uid).once('value').then(snap=>{
                if(!snap.exists()){
                  const adminObj = { name: DEFAULT_ADMIN_NAME, email: DEFAULT_ADMIN_EMAIL, role: 'admin' };
                  return db.ref('users/' + uid).set(adminObj);
                }
              });
            })
            .then(()=> auth.signOut())
            .catch(e=> console.warn('Could not auto-create admin:', e.message));
        } else {
          console.warn('Could not auto-create admin:', err.message);
        }
      });
  });
}

/* realtime listeners to keep local arrays up to date */
function attachListeners(){
  db.ref('users').on('value', snap=>{
    const v = snap.val() || {};
    users = Object.keys(v).map(k => ({ id: k, ...v[k] }));
    doctors = users.filter(u=>u.role==='doctor');
    patients = users.filter(u=>u.role==='patient');
    renderPatients();
    renderDoctorPatients();
    renderMyCard();
    fillDoctorOptions();
  });
  db.ref('clinics').on('value', snap=>{
    const v = snap.val() || {};
    clinics = Object.keys(v).map(k => ({ id: k, ...v[k] }));
    fillClinicOptions();
  });
}

/* UI show/hide */
function showPage(){
  authPage.style.display = currentUser ? "none":"flex";
  adminPage.style.display = currentUser && currentUser.role==='admin' ? "flex":"none";
  doctorPage.style.display = currentUser && currentUser.role==='doctor' ? "flex":"none";
  patientPage.style.display = currentUser && currentUser.role==='patient' ? "flex":"none";
  logoutBtn.style.display = currentUser ? 'inline-block':'none';
}

/* Login */
loginForm.addEventListener('submit', e=>{
  e.preventDefault();
  const email = loginEmail.value.trim();
  const password = loginPassword.value;
  const role = loginRole.value;

  auth.signInWithEmailAndPassword(email, password)
    .then(userCred=>{
      const uid = userCred.user.uid;
      return db.ref('users/' + uid).once('value').then(snap=>{
        const u = snap.val();
        if(!u) throw new Error('User record not found in database.');
        if(u.role !== role) throw new Error('Role mismatch for this account.');
        currentUser = { id: uid, ...u };
        showPage();
      });
    })
    .catch(err=>{
      alert('Login failed: ' + (err.message || err));
    });
});

/* Logout */
function logout(){
  currentUser = null;
  auth.signOut().catch(()=>{});
  showPage();
}

/* Signup (creates an auth user and DB record) */
signupForm.addEventListener('submit', e=>{
  e.preventDefault();
  const name = signupName.value.trim();
  const email = signupEmail.value.trim();
  const password = signupPassword.value;
  const role = signupRole.value;
  // keep original behavior requirement? original required @wec.com, preserve that rule:
  if(!email.endsWith("@wec.com")){ alert("Only @wec.com email allowed"); return; }

  auth.createUserWithEmailAndPassword(email, password)
    .then(userCred=>{
      const uid = userCred.user.uid;
      const userObj = { name, email, role };
      if(role === 'patient'){
        // keep patient fields empty initially; admin can set details later
        userObj.phone = "";
        userObj.age = "";
        userObj.problem = "";
        userObj.date = "";
        userObj.time = "";
        userObj.day = "";
        userObj.address = "";
      }
      return db.ref('users/' + uid).set(userObj).then(()=>{
        currentUser = { id: uid, ...userObj };
        showPage();
      });
    })
    .catch(err=>{
      alert('Sign up failed: ' + (err.message || err));
    });
});

/* Toggle auth forms */
showSignup.onclick = ()=>{ loginForm.style.display='none'; signupForm.style.display='flex'; }
showLogin.onclick = ()=>{ signupForm.style.display='none'; loginForm.style.display='flex'; }

/* Add Clinic */
clinicForm.addEventListener('submit', e=>{
  e.preventDefault();
  const clinic = {
    name: clinicName.value.trim(),
    address: clinicAddress.value.trim(),
    phone: clinicPhone.value.trim()
  };
  const newRef = db.ref('clinics').push();
  newRef.set(clinic).then(()=>{
    alert('Clinic added');
    clinicForm.reset();
  }).catch(err=>alert('Error adding clinic: '+err.message));
});

/* Add Doctor (creates auth user + DB user record) */
doctorForm.addEventListener('submit', e=>{
  e.preventDefault();
  const docEmail = doctorEmail.value.trim();
  const docPass = doctorPassword.value;
  const docObj = {
    name: doctorName.value.trim(),
    email: docEmail,
    role: 'doctor',
    clinicId: doctorClinic.value || ""
  };
  auth.createUserWithEmailAndPassword(docEmail, docPass)
    .then(userCred=>{
      const uid = userCred.user.uid;
      return db.ref('users/' + uid).set(docObj).then(()=>{
        alert('Doctor added');
        doctorForm.reset();
      });
    })
    .catch(err=>{
      alert('Error adding doctor: ' + (err.message || err));
    });
});

/* Add Patient (creates auth user + DB user record) */
patientForm.addEventListener('submit', e=>{
  e.preventDefault();
  const patEmail = patientEmail.value.trim();
  const patPass = patientPassword.value;
  const patObj = {
    name: patientName.value.trim(),
    email: patEmail,
    role: 'patient',
    phone: patientPhone.value.trim(),
    age: patientAge.value,
    problem: patientProblem.value.trim(),
    date: patientDate.value,
    time: patientTime.value,
    day: patientDay.value,
    address: patientAddress.value.trim(),
    doctorId: patientDoctor.value || ""
  };
  auth.createUserWithEmailAndPassword(patEmail, patPass)
    .then(userCred=>{
      const uid = userCred.user.uid;
      return db.ref('users/' + uid).set(patObj).then(()=>{
        alert('Patient added');
        patientForm.reset();
      });
    })
    .catch(err=>{
      alert('Error adding patient: ' + (err.message || err));
    });
});

/* Fill dropdowns */
function fillClinicOptions(){
  doctorClinic.innerHTML = clinics.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}
function fillDoctorOptions(){
  patientDoctor.innerHTML = doctors.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
}

/* Render lists */
function renderPatients(){
  patientsContainer.innerHTML='';
  patients.forEach(p=>{
    let card=document.createElement('div');
    card.className='card';
    card.innerHTML=`<h3>${p.name}</h3><p><b>Email:</b> ${p.email||''}</p><p><b>Phone:</b> ${p.phone||''}</p><p><b>Age:</b> ${p.age||''}</p><p><b>Problem:</b> ${p.problem||''}</p><p><b>Date:</b> ${p.date||''} ${p.time||''} (${p.day||''})</p><p><b>Address:</b> ${p.address||''}</p>
    <div><button class='outline' onclick="alert('SMS to ${p.phone||''}')">SMS</button><button class='outline' onclick="window.open('https://wa.me/${p.phone||''}','_blank')">WhatsApp</button><button class='outline' onclick='deleteUser(\"${p.id}\")'>Delete</button></div>`;
    patientsContainer.appendChild(card);
  });
}
function renderDoctorPatients(){
  doctorPatients.innerHTML='';
  if(currentUser && currentUser.role==='doctor'){
    let pats = patients.filter(p=>p.doctorId==currentUser.id);
    pats.forEach(p=>{
      let card=document.createElement('div');
      card.className='card';
      card.innerHTML=`<h3>${p.name}</h3><p><b>Email:</b> ${p.email||''}</p><p><b>Phone:</b> ${p.phone||''}</p><p><b>Age:</b> ${p.age||''}</p><p><b>Problem:</b> ${p.problem||''}</p><p><b>Date:</b> ${p.date||''} ${p.time||''} (${p.day||''})</p><p><b>Address:</b> ${p.address||''}</p><div><button class='outline' onclick="alert('SMS to ${p.phone||''}')">SMS</button><button class='outline' onclick="window.open('https://wa.me/${p.phone||''}','_blank')">WhatsApp</button></div>`;
      doctorPatients.appendChild(card);
    });
  }
}
function renderMyCard(){
  myCard.innerHTML='';
  if(currentUser && currentUser.role==='patient'){
    let p = currentUser;
    let card=document.createElement('div');
    card.className='card';
    card.innerHTML=`<h3>${p.name}</h3><p><b>Email:</b> ${p.email||''}</p><p><b>Phone:</b> ${p.phone||''}</p><p><b>Age:</b> ${p.age||''}</p><p><b>Problem:</b> ${p.problem||''}</p><p><b>Date:</b> ${p.date||''} ${p.time||''} (${p.day||''})</p><p><b>Address:</b> ${p.address||''}</p><div><button class='outline' onclick="alert('SMS to ${p.phone||''}')">SMS</button><button class='outline' onclick="window.open('https://wa.me/${p.phone||''}','_blank')">WhatsApp</button></div>`;
    myCard.appendChild(card);
  }
}

/* delete user (admin only) */
function deleteUser(uid){
  if(!confirm('Delete this user?')) return;
  db.ref('users/' + uid).remove().then(()=> alert('User removed')).catch(err=> alert('Error: '+err.message));
}

/* Search */
searchBox.addEventListener('input', e=>{
  let q = e.target.value.toLowerCase();
  document.querySelectorAll('#patientsContainer .card').forEach(c=>{
    c.style.display = c.textContent.toLowerCase().includes(q) ? 'flex' : 'none';
  });
});

/* onAuthState to populate currentUser if a user is signed-in (keep session across reload) */
auth.onAuthStateChanged(firebaseUser=>{
  if(firebaseUser){
    db.ref('users/' + firebaseUser.uid).once('value').then(snap=>{
      if(snap.exists()){
        currentUser = { id: firebaseUser.uid, ...snap.val() };
      } else {
        currentUser = null;
      }
      showPage();
    }).catch(()=>{ currentUser = null; showPage(); });
  } else {
    currentUser = null;
    showPage();
  }
});

/* initialize */
ensureDefaultAdmin();
attachListeners();
showPage();
</script>
</body>
</html>
